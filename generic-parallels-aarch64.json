{
  "variables": {
    "box_version": "{{env `VERSION`}}"
  },
  "provisioners": [
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora35/fixdns.sh",
        "scripts/fedora35/hostname.sh",
        "scripts/fedora35/dnf.sh"
      ],
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora35-aarch64-parallels"
      ]
    },
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora35/fixtmp.sh",
        "scripts/fedora35/base.sh"
      ],
      "pause_before": "120s",
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora35-aarch64-parallels"
      ]
    },
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora35/kernel.sh",
        "scripts/fedora35/vga.sh",
        "scripts/fedora35/virtualbox.sh",
        "scripts/fedora35/parallels.sh",
        "scripts/fedora35/vmware.sh",
        "scripts/fedora35/qemu.sh",
        "scripts/fedora35/vagrant.sh",
        "scripts/fedora35/tuning.sh",
        "scripts/fedora35/cleanup.sh"
      ],
      "pause_before": "120s",
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora35-aarch64-parallels"
      ]
    },
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora36/fixdns.sh",
        "scripts/fedora36/hostname.sh",
        "scripts/fedora36/dnf.sh"
      ],
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora36-aarch64-parallels"
      ]
    },
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora36/fixtmp.sh",
        "scripts/fedora36/base.sh"
      ],
      "pause_before": "120s",
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora36-aarch64-parallels"
      ]
    },
    {
      "type": "shell",
      "timeout": "120m",
      "scripts": [
        "scripts/fedora36/kernel.sh",
        "scripts/fedora36/vga.sh",
        "scripts/fedora36/virtualbox.sh",
        "scripts/fedora36/parallels.sh",
        "scripts/fedora36/vmware.sh",
        "scripts/fedora36/qemu.sh",
        "scripts/fedora36/vagrant.sh",
        "scripts/fedora36/tuning.sh",
        "scripts/fedora36/cleanup.sh"
      ],
      "pause_before": "120s",
      "start_retry_timeout": "45m",
      "expect_disconnect": "true",
      "only": [
        "generic-fedora36-aarch64-parallels"
      ]
    },
    {
      "scripts": [
        "scripts/common/motd.sh",
        "scripts/common/keys.sh",
        "scripts/common/machine.sh",
        "scripts/common/leases.sh",
        "scripts/common/localtime.sh",
        "scripts/common/zerodisk.sh",
        "scripts/common/lockout.sh"
      ],
      "type": "shell",
      "timeout": "120m",
      "start_retry_timeout": "45m",
      "expect_disconnect": "true"
    }
  ],
  "builders": [
    {
      "type": "parallels-iso",
      "name": "generic-fedora35-aarch64-parallels",
      "vm_name": "generic-fedora35-aarch64-parallels",
      "output_directory": "output/generic-fedora35-aarch64-parallels",
      "boot_wait": "20s",
      "boot_keygroup_interval": "1s",
      "boot_command": [
        "<up>e<wait1><down><down><wait2><leftCtrlOn>e<leftCtrlOff> ",
        "<wait>inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/generic.fedora35.vagrant.ks ",
        "<wait>biosdevname=0 ",
        "<wait>net.ifnames=0 ",
        "<wait><leftCtrlOn>x<leftCtrlOff>"
      ],
      "disk_size": 32768,
      "cpus": 2,
      "memory": 2048,
      "prlctl": [
        [
          "set",
          "{{.Name}}",
          "--adaptive-hypervisor",
          "on"
        ],
        [
          "set",
          "{{.Name}}",
          "--3d-accelerate",
          "off"
        ],
        [
          "set",
          "{{.Name}}",
          "--videosize",
          "16"
        ],
        [
          "set",
          "{{.Name}}",
          "--pmu-virt",
          "on"
        ],
        [
          "set",
          "{{.Name}}",
          "--faster-vm",
          "on"
        ]
      ],
      "hard_drive_interface": "sata",
      "guest_os_type": "fedora-core",
      "skip_compaction": false,
      "http_directory": "http",
      "iso_url": "https://dl.fedoraproject.org/pub/fedora/linux/releases/35/Server/aarch64/iso/Fedora-Server-netinst-aarch64-35-1.2.iso",
      "iso_checksum": "sha256:7a70e82bd8902a749f1616722a30b96c838b109baccaee5f19870fa6eb55aa22",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_timeout": "3600s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "parallels_tools_flavor": "lin-arm",
      "parallels_tools_mode": "upload",
      "parallels_tools_guest_path": "/root/parallels-tools-linux.iso",
      "prlctl_version_file": "/root/parallels-tools-version.txt"
    },
    {
      "type": "parallels-iso",
      "name": "generic-fedora36-aarch64-parallels",
      "vm_name": "generic-fedora36-aarch64-parallels",
      "output_directory": "output/generic-fedora36-aarch64-parallels",
      "boot_wait": "20s",
      "boot_keygroup_interval": "1s",
      "boot_command": [
        "<up>e<wait1><down><down><wait2><leftCtrlOn>e<leftCtrlOff> ",
        "<wait>inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/generic.fedora36.vagrant.ks ",
        "<wait>biosdevname=0 ",
        "<wait>net.ifnames=0 ",
        "<wait><leftCtrlOn>x<leftCtrlOff>"
      ],
      "disk_size": 32768,
      "cpus": 2,
      "memory": 2048,
      "prlctl": [
        [
          "set",
          "{{.Name}}",
          "--adaptive-hypervisor",
          "on"
        ],
        [
          "set",
          "{{.Name}}",
          "--3d-accelerate",
          "off"
        ],
        [
          "set",
          "{{.Name}}",
          "--videosize",
          "16"
        ],
        [
          "set",
          "{{.Name}}",
          "--pmu-virt",
          "on"
        ],
        [
          "set",
          "{{.Name}}",
          "--faster-vm",
          "on"
        ]
      ],
      "hard_drive_interface": "sata",
      "guest_os_type": "fedora-core",
      "skip_compaction": false,
      "http_directory": "http",
      "iso_url": "https://dl.fedoraproject.org/pub/fedora/linux/releases/36/Server/aarch64/iso/Fedora-Server-netinst-aarch64-36-1.5.iso",
      "iso_checksum": "sha256:058174fad13312ac1f86276fd65b0c1aefdbe28ad47e7fd75b9dcae2a7317bd0",
      "ssh_username": "root",
      "ssh_password": "vagrant",
      "ssh_port": 22,
      "ssh_timeout": "3600s",
      "shutdown_command": "echo 'vagrant' | sudo -S shutdown -P now",
      "parallels_tools_flavor": "lin",
      "parallels_tools_mode": "upload",
      "parallels_tools_guest_path": "/root/parallels-tools-linux.iso",
      "prlctl_version_file": "/root/parallels-tools-version.txt"
    }
  ],
  "post-processors": [
    [
      {
        "type": "shell-local",
        "inline": [
          "prl_disk_tool merge --hdd output/{{build_name}}/{{build_name}}.pvm/harddisk1.hdd",
          "prl_disk_tool compact --hdd output/{{build_name}}/{{build_name}}.pvm/harddisk1.hdd"
        ]
      },
      {
        "type": "vagrant",
        "compression_level": 9,
        "keep_input_artifact": false,
        "vagrantfile_template": "tpl/generic-{{split build_name \"-\" 1}}.rb",
        "output": "output/generic-{{split build_name \"-\" 1}}-{{split build_name \"-\" 2}}-{{split build_name \"-\" 3}}-{{user `box_version`}}.box",
        "include": [
          "tpl/generic/info.json"
        ]
      },
      {
        "type": "checksum",
        "checksum_types": [
          "sha256"
        ],
        "keep_input_artifact": false,
        "output": "output/generic-{{split build_name \"-\" 1}}-{{split build_name \"-\" 2}}-{{split build_name \"-\" 3}}-{{user `box_version`}}.box.sha256"
      }
    ]
  ]
}
